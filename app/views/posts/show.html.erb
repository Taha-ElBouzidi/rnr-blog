<div class="container">
  <div class="card">
    <%= render "posts/status_badge", post: @post %>
    
    <h1 class="text-3xl font-bold text-gray-900 mb-3"><%= @post.title %></h1>
    
    <div class="flex items-center gap-2 p-3 bg-gray-100 rounded-md mb-4">
      <%= avatar_initials(@post.user, size: 'md') %>
      <div>
        <div class="font-semibold text-sm"><%= @post.user&.name || "Unknown Author" %></div>
        <div class="text-gray-600 text-xs">
          <%= @post.user&.email %>
          <% if @post.published_at %>
            â€¢ Published <%= time_ago_in_words(@post.published_at) %> ago
          <% end %>
        </div>
      </div>
    </div>
    
    <% if @post.cover_image.attached? %>
      <div class="mb-4">
        <%= image_tag @post.cover_image.variant(resize_to_limit: [1920, 1080]), 
                      class: "w-full rounded-lg shadow-md", 
                      alt: @post.title %>
      </div>
    <% end %>

    <div class="mb-4 leading-relaxed text-sm">
      <%= simple_format(@post.body) %>
    </div>
    
    <div class="flex gap-2 pt-3 border-t border-gray-200">
      <%= link_to "Back to Posts", posts_path, class: "btn btn-secondary" %>
      <% if allowed_to?(:update?, @post) %>
        <%= link_to "Edit", edit_post_path(@post), class: "btn btn-secondary" %>
      <% end %>
      <% if allowed_to?(:destroy?, @post) %>
        <%= button_to "Delete", post_path(@post), method: :delete, 
            data: { turbo: false }, class: "btn btn-danger ml-auto" %>
      <% end %>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center gap-2 mb-4">
      <h2 class="text-xl font-bold">Comments</h2>
      <span class="badge badge-info"><%= @post.comments_count %></span>
    </div>
    
    <% if current_user %>
      <%= turbo_frame_tag "new_comment_form" do %>
        <div class="mb-4 p-3 bg-gray-100 rounded-md">
          <%= form_with model: [@post, @post.comments.build], data: { turbo_frame: "new_comment_form", controller: "form-submit", action: "turbo:submit-start->form-submit#disableSubmit turbo:submit-end->form-submit#enable" } do |f| %>
            <%= f.text_area :body, rows: 3, placeholder: "Write a comment...", 
                class: "form-textarea mb-2" %>
            <%= f.submit "Post Comment", class: "btn btn-success", data: { form_submit_target: "submit" } %>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="mb-4 p-3 bg-yellow-50 rounded-md text-center">
        <p class="text-yellow-800 text-sm m-0">
          Please <%= link_to "login", new_user_session_path, class: "text-blue-600 font-semibold" %> to leave a comment
        </p>
      </div>
    <% end %>

    <div id="comments">
      <% @post.comments.each do |comment| %>
        <%= turbo_frame_tag dom_id(comment) do %>
          <%= render "comments/comment", comment: comment, post: @post %>
        <% end %>
      <% end %>

      <% if @post.comments.empty? %>
        <div class="text-center py-8 bg-gray-100 rounded-md">
          <p class="text-gray-600 text-sm m-0">No comments yet. Start the conversation!</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
